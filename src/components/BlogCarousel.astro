---
import BlogCard from "./BlogCard.astro";
import { ChevronLeft, ChevronRight } from "lucide-astro";
import type { ImageMetadata } from "astro";

interface BlogPost {
  id: string;
  data: {
    title: string;
    date: string;
    featured_image: ImageMetadata;
    excerpt: string;
    tags: string[];
  };
}

interface Props {
  posts: BlogPost[];
}

const { posts } = Astro.props;
---

<section aria-label="Blog Posts Carousel" class="space-y-6 sm:space-y-8">
  <div>
    <p class="text-base sm:text-lg text-gray-700 dark:text-gray-300 leading-relaxed">
      Deep dives into technical challenges I've tackled, from teaching an AI
      dog new tricks to wrestling with WebSockets. These posts explore the reality
      of software development - accidental rabbit holes and JSON-induced
      existential crisis.
    </p>
  </div>

  <div class="embla-blog relative" aria-roledescription="carousel">
    <!-- Carousel Viewport -->
    <div class="embla-blog__viewport overflow-hidden py-2">
      <div class="embla-blog__container flex gap-3 sm:gap-4" role="list">
        {
          posts.map((post, index) => (
            <div
              class="embla-blog__slide flex-[0_0_100%] md:flex-[0_0_calc(50%-0.5rem)] min-w-0"
              role="listitem"
              aria-roledescription="slide"
              aria-label={`${index + 1} of ${posts.length}: ${post.data.title}`}
            >
              <BlogCard slug={post.id} metadata={post.data} index={index} />
            </div>
          ))
        }
      </div>
    </div>

    <!-- Navigation Arrows -->
    <button
      type="button"
      class="embla-blog__prev invisible hidden md:flex absolute left-0 top-1/2 -translate-y-1/2 -translate-x-14 lg:-translate-x-16 z-10
        w-10 h-10 lg:w-12 lg:h-12 items-center justify-center
        bg-white dark:bg-gray-800 rounded-full shadow-lg
        border border-gray-200 dark:border-gray-700
        text-gray-600 dark:text-gray-300
        hover:bg-gray-50 dark:hover:bg-gray-700
        hover:text-gray-900 dark:hover:text-white
        disabled:opacity-40 disabled:cursor-not-allowed
        transition-all duration-200"
      aria-label="Previous post"
      disabled
    >
      <ChevronLeft class="w-5 h-5 lg:w-6 lg:h-6" />
    </button>

    <button
      type="button"
      class="embla-blog__next hidden md:flex absolute right-0 top-1/2 -translate-y-1/2 translate-x-14 lg:translate-x-16 z-10
        w-10 h-10 lg:w-12 lg:h-12 items-center justify-center
        bg-white dark:bg-gray-800 rounded-full shadow-lg
        border border-gray-200 dark:border-gray-700
        text-gray-600 dark:text-gray-300
        hover:bg-gray-50 dark:hover:bg-gray-700
        hover:text-gray-900 dark:hover:text-white
        disabled:opacity-40 disabled:cursor-not-allowed
        transition-all duration-200"
      aria-label="Next post"
    >
      <ChevronRight class="w-5 h-5 lg:w-6 lg:h-6" />
    </button>

    <!-- Dot Indicators -->
    <div
      class="embla-blog__dots flex justify-center gap-2 mt-4"
      role="tablist"
      aria-label="Slide navigation"
    >
      {
        posts.map((_, index) => (
          <button
            type="button"
            class:list={[
              "embla-blog__dot w-2.5 h-2.5 rounded-full transition-colors duration-200",
              index === 0
                ? "bg-blue-600 dark:bg-blue-500"
                : "bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500",
            ]}
            role="tab"
            aria-label={`Go to slide ${index + 1}`}
            aria-selected={index === 0 ? "true" : "false"}
            data-index={index}
          />
        ))
      }
    </div>
  </div>
</section>

<script>
  import EmblaCarousel from "embla-carousel";

  function initBlogCarousel() {
    const emblaNode = document.querySelector(".embla-blog__viewport");
    if (!emblaNode) return;

    const embla = EmblaCarousel(emblaNode as HTMLElement, {
      loop: false,
      align: "start",
      containScroll: false,
    });

    const prevBtn = document.querySelector(".embla-blog__prev");
    const nextBtn = document.querySelector(".embla-blog__next");
    const dots = document.querySelectorAll(".embla-blog__dot");

    // Navigation buttons
    prevBtn?.addEventListener("click", () => embla.scrollPrev());
    nextBtn?.addEventListener("click", () => embla.scrollNext());

    // Dot navigation
    dots.forEach((dot) => {
      dot.addEventListener("click", () => {
        const index = parseInt(dot.getAttribute("data-index") || "0", 10);
        embla.scrollTo(index);
      });
    });

    // Update dots on slide change
    const updateDots = () => {
      const selected = embla.selectedScrollSnap();
      dots.forEach((dot, index) => {
        const isSelected = index === selected;
        dot.setAttribute("aria-selected", isSelected ? "true" : "false");
        if (isSelected) {
          dot.classList.remove("bg-gray-300", "dark:bg-gray-600", "hover:bg-gray-400", "dark:hover:bg-gray-500");
          dot.classList.add("bg-blue-600", "dark:bg-blue-500");
        } else {
          dot.classList.remove("bg-blue-600", "dark:bg-blue-500");
          dot.classList.add("bg-gray-300", "dark:bg-gray-600", "hover:bg-gray-400", "dark:hover:bg-gray-500");
        }
      });
    };

    // Update button states
    const updateButtons = () => {
      if (prevBtn) {
        const canScrollPrev = embla.canScrollPrev();
        (prevBtn as HTMLButtonElement).disabled = !canScrollPrev;
        prevBtn.classList.toggle("invisible", !canScrollPrev);
      }
      if (nextBtn) {
        const canScrollNext = embla.canScrollNext();
        (nextBtn as HTMLButtonElement).disabled = !canScrollNext;
        nextBtn.classList.toggle("invisible", !canScrollNext);
      }
    };

    embla.on("select", updateDots);
    embla.on("select", updateButtons);
    embla.on("init", updateDots);
    embla.on("init", updateButtons);

    // Keyboard navigation
    emblaNode.setAttribute("tabindex", "0");
    emblaNode.addEventListener("keydown", (e: Event) => {
      const keyEvent = e as KeyboardEvent;
      if (keyEvent.key === "ArrowLeft") {
        embla.scrollPrev();
        keyEvent.preventDefault();
      } else if (keyEvent.key === "ArrowRight") {
        embla.scrollNext();
        keyEvent.preventDefault();
      }
    });
  }

  // Initialize on page load
  initBlogCarousel();

  // Re-initialize on Astro page transitions
  document.addEventListener("astro:page-load", initBlogCarousel);
</script>
